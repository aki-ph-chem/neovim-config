name: update lazy-lock.json 
on:
  pull_request:
    paths:
      - 'nvim/**'
  workflow_dispatch:

jobs:
  udpate-lockfile:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}:latest

    steps:
      - uses: actions/checkout@v4

      - name: DEBUG (show current directory) 
        run: |
          echo "DEBUG: current directory: $PWD"

      - name: DEBUG (show $HOME)
        run: |
          echo -e "DEBUG: home directory: $HOME"

      - name: DEBUG (show nvim version) 
        run: |
          echo -e "DEBUG: nvim version:\n$(/root/nvim-linux-x86_64/bin/nvim --version)"

      - name: setup config files 
        run: |
          mkdir "$HOME/.config"
          ln -s "$PWD/nvim" "$HOME/.config/nvim"

      - name: DEBUG (check symlink)
        run: |
          echo -e "DEBUG: check symlink:\n$(cat ${HOME}/.config/nvim/init.lua  | head -15)"

      - name: install plugins
        run: |
          TS_OFF=1 USER=root /root/nvim-linux-x86_64/bin/nvim  --headless +qa

      - name: update plugins
        run: |
          TS_OFF=1 USER=root /root/nvim-linux-x86_64/bin/nvim  --headless "+Lazy! sync" +qa

      - name: show lazy-lock.json  
        run: |
          cat nvim/lazy-lock.json
